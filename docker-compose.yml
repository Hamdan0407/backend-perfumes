version: '3.8'

# PRODUCTION-ONLY Docker Compose
# 
# MANDATORY ENVIRONMENT VARIABLES:
# - DATABASE_URL: Database connection string
# - DATABASE_USERNAME, DATABASE_PASSWORD: Database credentials
# - REDIS_HOST, REDIS_PORT: Redis configuration
# - JWT_SECRET: 256+ bit secret key
# - RAZORPAY_KEY_ID, RAZORPAY_KEY_SECRET: LIVE Razorpay keys (NOT test)
# - MAIL_USERNAME, MAIL_PASSWORD: Email credentials
# - CORS_ORIGINS: Production frontend URL
#
# Usage: docker-compose --env-file .env.production up --build

services:
  # ==========================================
  # Redis Cache Layer - MANDATORY FOR PRODUCTION
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: perfume-shop-redis
    restart: unless-stopped
    
    ports:
      - "6379:6379"
    
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_secure_password_change_me}
    
    volumes:
      - redis-data:/data
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    
    networks:
      - perfume-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================
  # MySQL Database Service - PRODUCTION
  # ==========================================
  database:
    image: mysql:8.0-alpine
    container_name: perfume-shop-db
    restart: unless-stopped
    
    environment:
      MYSQL_DATABASE: perfume_shop
      MYSQL_ROOT_PASSWORD: ${DATABASE_ROOT_PASSWORD}
      MYSQL_USER: ${DATABASE_USERNAME}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD}
      TZ: 'UTC'
    
    # Port mapping
    ports:
      - "3306:3306"
    
    # Data persistence
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DATABASE_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    
    networks:
      - perfume-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================
  # Spring Boot API Service - PRODUCTION
  # ==========================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        JAR_FILE: target/perfume-shop-1.0.0.jar
    
    container_name: perfume-shop-api
    restart: unless-stopped
    
    # Wait for dependencies before starting
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # ===== PRODUCTION ENVIRONMENT VARIABLES =====
    environment:
      # ===== Spring Profile: PRODUCTION ONLY =====
      SPRING_PROFILES_ACTIVE: prod
      
      # ===== Server Configuration =====
      PORT: 8080
      SERVER_PORT: 8080
      ENVIRONMENT: production
      
      # ===== JVM Configuration =====
      JAVA_OPTS: "-Dspring.main.allow-circular-references=true -Xmx1g -Xms512m -XX:+UseG1GC"
      
      # ===== DATABASE CONFIGURATION - PRODUCTION =====
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_USERNAME: ${DATABASE_USERNAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_POOL_SIZE: ${DATABASE_POOL_SIZE:-20}
      
      # ===== REDIS CONFIGURATION - MANDATORY FOR PRODUCTION =====
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE: 0
      REDIS_SSL: false
      
      # ===== JWT CONFIGURATION - PRODUCTION KEYS =====
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: 86400000
      JWT_REFRESH_EXPIRATION: 604800000
      JWT_GRACE_PERIOD: 60000
      
      # ===== SECURITY CONFIGURATION =====
      CORS_ORIGINS: ${CORS_ORIGINS}
      CORS_ALLOW_CREDENTIALS: true
      PASSWORD_ENCODER_STRENGTH: 12
      
      # ===== EMAIL CONFIGURATION - PRODUCTION SMTP =====
      MAIL_HOST: ${MAIL_HOST:smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      EMAIL_MAX_RETRIES: 3
      
      # ===== PAYMENT GATEWAY: RAZORPAY - LIVE KEYS ONLY =====
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET}
      RAZORPAY_WEBHOOK_SECRET: ${RAZORPAY_WEBHOOK_SECRET}
      RAZORPAY_CURRENCY: INR
      
      # ===== PAYMENT GATEWAY: STRIPE (Optional) =====
      STRIPE_API_KEY: ${STRIPE_API_KEY:}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:}
      
      # ===== FRONTEND CONFIGURATION =====
      FRONTEND_URL: ${FRONTEND_URL}
      
      # ===== LOGGING CONFIGURATION =====
      LOG_DIR: /var/log/perfume-shop
      LOG_LEVEL: INFO
      APP_LOG_LEVEL: INFO
    
    ports:
      - "8080:8080"
      - "9090:9090"  # Management/actuator port
    
    volumes:
      - logs:/var/log/perfume-shop
    
    networks:
      - perfume-network
    
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # ==========================================
  # Frontend - Nginx serving React build
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    
    container_name: perfume-shop-frontend
    restart: unless-stopped
    
    # Environment variables for frontend
    environment:
      - VITE_API_URL=${BACKEND_URL:-http://localhost:8080}
    
    ports:
      - "3000:80"
    
    networks:
      - perfume-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

# ==========================================
# NETWORK CONFIGURATION
# ==========================================
networks:
  perfume-network:
    driver: bridge

# ==========================================
# VOLUMES FOR DATA PERSISTENCE
# ==========================================
volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  logs:
    driver: local
  api-logs:
    driver: local

# ==========================================
# Important Notes:
# ==========================================
# 1. Build the backend JAR before starting:
#    mvn clean package -DskipTests
#
# 2. Create .env file with required environment variables:
#    cp .env.production.example .env.production
#
# 3. Start services with environment file:
#    docker compose --env-file .env.production up --build
#
# 4. Without --env-file, use shell exports:
#    export DATABASE_PASSWORD="secure_password"
#    export JWT_SECRET="base64_encoded_secret"
#    docker compose up --build
#
# 5. View logs:
#    docker compose logs -f api
#    docker compose logs -f database
#
# 6. Database health check:
#    docker compose exec database mysql -u prod_user -p perfume_shop -e "SELECT 1;"
#
# 7. API health check:
#    curl http://localhost:8080/actuator/health
#
# 8. Stop services:
#    docker compose down
#
# 9. Remove volumes (WARNING: deletes data):
#    docker compose down -v
