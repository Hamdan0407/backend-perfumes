version: '3.8'

# Production-Ready Docker Compose Setup
# Usage: docker compose up --build
# 
# Environment Variables (required in .env file or shell):
# - DATABASE_USERNAME: MySQL user (default: prod_user)
# - DATABASE_PASSWORD: MySQL password (default: prod_password)
# - JWT_SECRET: JWT signing secret (256 bits minimum)
# - MAIL_USERNAME: Email sender address
# - MAIL_PASSWORD: Email sender password/token
# - RAZORPAY_KEY_ID: Razorpay key ID
# - RAZORPAY_KEY_SECRET: Razorpay key secret
# - RAZORPAY_WEBHOOK_SECRET: Razorpay webhook secret
# - CORS_ORIGINS: Comma-separated CORS origins
# - FRONTEND_URL: Frontend application URL
#
# Optional:
# - MAIL_HOST: Email SMTP host (default: smtp.gmail.com)
# - MAIL_PORT: Email SMTP port (default: 587)
# - STRIPE_API_KEY: Stripe API key
# - STRIPE_WEBHOOK_SECRET: Stripe webhook secret

services:
  # ==========================================
  # MySQL Database Service
  # ==========================================
  database:
    image: mysql:8.0
    container_name: perfume-shop-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: perfume_shop
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
      MYSQL_USER: ${DATABASE_USERNAME:-prod_user}
      MYSQL_PASSWORD: ${DATABASE_PASSWORD:-prod_password}
      TZ: 'UTC'
    
    # Port mapping (changed to 3307 to avoid local MySQL conflict)
    ports:
      - "3307:3306"
    
    # Data persistence
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    
    # Health check disabled to allow startup
    # healthcheck:
    #   test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 15s
    
    networks:
      - perfume-network
    
    # Resource limits (optional, uncomment to enable)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

  # ==========================================
  # Spring Boot API Service
  # ==========================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Can pass build arguments if needed
        JAR_FILE: target/perfume-shop-1.0.0.jar
    
    container_name: perfume-shop-api
    restart: unless-stopped
    
    # Ensure database is started before starting
    depends_on:
      database:
        condition: service_started
    
    environment:
      # ===== Spring Profile (enables application-demo.yml for DEMO mode) =====
      # Use: prod, demo, or dev
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-demo}
      
      # ===== Server Configuration =====
      PORT: 8080
      SERVER_PORT: 8080
      ENVIRONMENT: production
      
      # ===== JVM Configuration =====
      # Allow circular references in Spring beans (required for this application)
      # Combined with memory and GC settings
      JAVA_OPTS: "-Dspring.main.allow-circular-references=true -Xmx1g -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
      
      # ===== Database Configuration =====
      # Use docker service name 'database' as hostname
      DATABASE_URL: jdbc:mysql://database:3306/perfume_shop?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      DATABASE_USERNAME: ${DATABASE_USERNAME:-prod_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-prod_password}
      DATABASE_POOL_SIZE: ${DATABASE_POOL_SIZE:-20}
      DATABASE_CONNECTION_TIMEOUT: 10000
      DATABASE_MAX_IDLE_TIME: 300000
      
      # ===== JWT Configuration =====
      # CRITICAL: Must be 256+ bits. Example: openssl rand -base64 32
      JWT_SECRET: ${JWT_SECRET:-MySecureJWTSecretKeyForPerfumeShopApplicationDevelopment2024!@#$%}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-604800000}
      JWT_GRACE_PERIOD: ${JWT_GRACE_PERIOD:-60000}
      
      # ===== Security Configuration =====
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      CORS_MAX_AGE: ${CORS_MAX_AGE:-3600}
      PASSWORD_ENCODER_STRENGTH: ${PASSWORD_ENCODER_STRENGTH:-12}
      
      # ===== Email Configuration =====
      MAIL_HOST: ${MAIL_HOST:-smtp.gmail.com}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_FROM: ${MAIL_FROM:-noreply@perfume.com}
      EMAIL_MAX_RETRIES: ${EMAIL_MAX_RETRIES:-3}
      EMAIL_RETRY_DELAY: ${EMAIL_RETRY_DELAY:-5000}
      
      # ===== Payment Gateway: Stripe =====
      STRIPE_API_KEY: ${STRIPE_API_KEY}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      
      # ===== Payment Gateway: Razorpay =====
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-rzp_test_dGMw8VZM1fV3Zn}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-w7yJvM2kLnP9qR4sT5uV}
      RAZORPAY_WEBHOOK_SECRET: ${RAZORPAY_WEBHOOK_SECRET:-test_webhook_secret}
      RAZORPAY_CURRENCY: ${RAZORPAY_CURRENCY:-INR}
      
      # ===== Frontend Configuration =====
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      
      # ===== Logging Configuration =====
      LOG_DIR: /var/log/perfume-shop
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      APP_LOG_LEVEL: ${APP_LOG_LEVEL:-INFO}
      SPRING_LOG_LEVEL: ${SPRING_LOG_LEVEL:-WARN}
      SPRING_SECURITY_LOG_LEVEL: ${SPRING_SECURITY_LOG_LEVEL:-WARN}
      SPRING_WEB_LOG_LEVEL: ${SPRING_WEB_LOG_LEVEL:-WARN}
      LOG_MAX_FILE_SIZE: 100MB
      LOG_MAX_BACKUP_INDEX: 7

    
    # Port mapping
    ports:
      - "8080:8080"    # API server
      - "9090:9090"    # Management/Actuator endpoints
    
    # Data persistence
    volumes:
      - api-logs:/var/log/perfume-shop
    
    # Health check disabled to allow startup
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 45s
    
    networks:
      - perfume-network
    
    # Logging driver
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ==========================================
  # Frontend Service (React + Nginx)
  # Uncomment to enable frontend service
  # ==========================================
  # Frontend Service (React + Nginx)
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: http://localhost:8080/api
        VITE_API_URL: http://localhost:8080/api
    
    container_name: perfume-shop-frontend
    restart: unless-stopped
    
    depends_on:
      - api
    
    environment:
      # Environment variables during build
      REACT_APP_API_URL: http://localhost:8080/api
      VITE_API_URL: http://localhost:8080/api
      NODE_ENV: production
    
    ports:
      - "3000:80"
    
    networks:
      - perfume-network
    
    # Health check disabled to allow startup
    # healthcheck:
    #   test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/index.html"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 15s

# ==========================================
# Volumes for Data Persistence
# ==========================================
volumes:
  # MySQL data persistence
  mysql-data:
    driver: local
  
  # API logs persistence
  api-logs:
    driver: local

# ==========================================
# Docker Network for Inter-Service Communication
# ==========================================
networks:
  perfume-network:
    driver: bridge

# ==========================================
# Important Notes:
# ==========================================
# 1. Build the backend JAR before starting:
#    mvn clean package -DskipTests
#
# 2. Create .env file with required environment variables:
#    cp .env.production.example .env.production
#
# 3. Start services with environment file:
#    docker compose --env-file .env.production up --build
#
# 4. Without --env-file, use shell exports:
#    export DATABASE_PASSWORD="secure_password"
#    export JWT_SECRET="base64_encoded_secret"
#    docker compose up --build
#
# 5. View logs:
#    docker compose logs -f api
#    docker compose logs -f database
#
# 6. Database health check:
#    docker compose exec database mysql -u prod_user -p perfume_shop -e "SELECT 1;"
#
# 7. API health check:
#    curl http://localhost:8080/actuator/health
#
# 8. Stop services:
#    docker compose down
#
# 9. Remove volumes (WARNING: deletes data):
#    docker compose down -v
