# Nginx Configuration for Perfume Shop
# Production setup: Railway backend + Vercel frontend + Nginx media serving
# 
# Replace:
# - yourdomain.com with your actual domain
# - your-railway-api.railway.app with your Railway API URL
# - SSL certificate paths with your Let's Encrypt paths

# Upstream backend server
upstream railway_backend {
    server your-railway-api.railway.app;
    keepalive 32;
}

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    
    client_max_body_size 10M;
    
    # ACME challenge for Let's Encrypt renewal
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # Redirect all HTTP to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # ==========================================
    # SSL Configuration (Let's Encrypt)
    # ==========================================
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    # SSL protocols and ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5:!3DES;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # ==========================================
    # Security Headers
    # ==========================================
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # ==========================================
    # Performance & Compression
    # ==========================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    
    # Max body size for uploads
    client_max_body_size 10M;
    
    # ==========================================
    # Logging
    # ==========================================
    access_log /var/log/nginx/perfume-shop-access.log combined;
    error_log /var/log/nginx/perfume-shop-error.log warn;
    
    # Disable logging for health checks
    map $request_uri $loggable {
        default 1;
        ~^/health$ 0;
        ~^/api/actuator/health$ 0;
    }
    access_log /var/log/nginx/perfume-shop-access.log combined if=$loggable;
    
    # ==========================================
    # SERVE MEDIA FILES FROM NGINX (Static)
    # ==========================================
    location /media/ {
        # Directory where files are stored (created by backend)
        alias /var/www/perfume-shop/media/;
        
        # Cache strategy
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header ETag "\"$file_mtime-$file_size\"";
        
        # Allow direct access to image files
        location ~ \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # Security: Prevent access to non-image files
        location ~ \.(php|phtml|phar|pht|phps|pht|phtml|pgif|shtml|php3|php4|php5|php7|phps|php-s|phtml)$ {
            return 403;
        }
        
        # Prevent access to hidden files
        location ~ /\. {
            return 404;
        }
    }
    
    # ==========================================
    # PROXY API REQUESTS TO RAILWAY BACKEND
    # ==========================================
    location /api/ {
        # Proxy to Railway API
        proxy_pass https://your-railway-api.railway.app/api/;
        
        # Required headers
        proxy_set_header Host your-railway-api.railway.app;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host yourdomain.com;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # SSL verification (adjust if needed)
        proxy_ssl_verify off;  # Disable if Railway has self-signed cert
        proxy_ssl_session_reuse on;
    }
    
    # ==========================================
    # WEBHOOKS (Razorpay)
    # ==========================================
    location /api/webhooks/razorpay {
        proxy_pass https://your-railway-api.railway.app/api/webhooks/razorpay;
        
        proxy_set_header Host your-railway-api.railway.app;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # Important for webhooks: preserve request body
        proxy_request_buffering off;
        proxy_buffering off;
        
        proxy_connect_timeout 10s;
        proxy_read_timeout 10s;
    }
    
    # ==========================================
    # HEALTH CHECK ENDPOINT
    # ==========================================
    location /health {
        access_log off;
        proxy_pass https://your-railway-api.railway.app/api/actuator/health;
        proxy_set_header Host your-railway-api.railway.app;
    }
    
    # ==========================================
    # ROOT - Redirect to Vercel Frontend
    # ==========================================
    location / {
        # Redirect to Vercel frontend
        return 301 https://your-app.vercel.app$request_uri;
    }
    
    # ==========================================
    # REJECT UNWANTED REQUESTS
    # ==========================================
    location ~ /\. {
        # Deny access to hidden files/directories
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ~$ {
        # Deny backup files
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Disable HTTP TRACE method
    if ($request_method = TRACE) {
        return 405;
    }
}

# Rate limiting
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=upload_limit:10m rate=5r/s;

# Apply rate limits to API
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    location /api/media/upload {
        limit_req zone=upload_limit burst=5 nodelay;
        # ... rest of upload config
    }
    
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        # ... rest of API config
    }
}
