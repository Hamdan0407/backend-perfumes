# Environment Variables Setup Guide
# For Vercel + Railway + Nginx + PostgreSQL Deployment

## Railway Backend Environment Variables

Add all these variables in Railway Dashboard > Variables tab:

```bash
# ==========================================
# DATABASE (Auto-generated from PostgreSQL service)
# ==========================================
DATABASE_URL=postgresql://username:password@hostname:5432/railway
PGUSER=postgres
PGPASSWORD=<auto-generated>
PGHOST=<auto-generated>
PGPORT=5432
PGDATABASE=railway

# ==========================================
# JWT CONFIGURATION
# ==========================================
JWT_SECRET=<generate-with-this-command>
# Run: openssl rand -base64 32
# Keep this secret! Never commit to git

JWT_EXPIRATION=86400000
JWT_REFRESH_EXPIRATION=604800000
JWT_GRACE_PERIOD=60000

# ==========================================
# CORS CONFIGURATION
# ==========================================
# Allow your Vercel frontend and custom domain
CORS_ORIGINS=https://your-app.vercel.app,https://www.your-app.vercel.app,https://yourdomain.com,https://www.yourdomain.com

CORS_MAX_AGE=3600

# ==========================================
# EMAIL CONFIGURATION (SendGrid Recommended)
# ==========================================
MAIL_HOST=smtp.sendgrid.net
MAIL_PORT=587
MAIL_USERNAME=apikey
MAIL_PASSWORD=SG.your_actual_sendgrid_api_key
MAIL_FROM=noreply@yourdomain.com
MAIL_FROM_NAME=Parfumé

# Email retry configuration
EMAIL_MAX_RETRIES=3
EMAIL_RETRY_DELAY=5000

# ==========================================
# RAZORPAY PAYMENT GATEWAY (Live Mode)
# ==========================================
# Get from: https://dashboard.razorpay.com/app/settings/api-keys
RAZORPAY_KEY_ID=rzp_live_your_actual_key_id
RAZORPAY_KEY_SECRET=your_actual_razorpay_secret_key
RAZORPAY_WEBHOOK_SECRET=your_actual_webhook_signing_secret
RAZORPAY_CURRENCY=INR

# ==========================================
# FRONTEND CONFIGURATION
# ==========================================
FRONTEND_URL=https://your-app.vercel.app

# ==========================================
# MEDIA/FILE CONFIGURATION
# ==========================================
MEDIA_URL=https://yourdomain.com/media
MEDIA_UPLOAD_DIR=/tmp/media

# ==========================================
# LOGGING CONFIGURATION
# ==========================================
LOG_LEVEL=INFO
LOG_DIR=/tmp/logs
LOG_MAX_FILE_SIZE=10MB
LOG_MAX_BACKUP_INDEX=5

SPRING_LOG_LEVEL=WARN
SPRING_SECURITY_LOG_LEVEL=WARN
SPRING_WEB_LOG_LEVEL=WARN

# ==========================================
# SERVER CONFIGURATION
# ==========================================
SPRING_PROFILES_ACTIVE=prod
PORT=8080
ENVIRONMENT=production

# ==========================================
# PASSWORD ENCODING
# ==========================================
PASSWORD_ENCODER_STRENGTH=12

# ==========================================
# DATABASE POOL CONFIGURATION
# ==========================================
DATABASE_POOL_SIZE=10
DATABASE_CONNECTION_TIMEOUT=10000
DATABASE_MAX_IDLE_TIME=600000
```

---

## Vercel Frontend Environment Variables

Add these in Vercel Dashboard > Project Settings > Environment Variables:

```bash
# ==========================================
# API CONFIGURATION
# ==========================================
VITE_API_URL=https://your-project.railway.app/api
# Or if using custom domain:
# VITE_API_URL=https://yourdomain.com/api

# ==========================================
# RAZORPAY CONFIGURATION
# ==========================================
# Get from: https://dashboard.razorpay.com/app/settings/api-keys (Live mode)
VITE_RAZORPAY_KEY=rzp_live_your_actual_public_key

# ==========================================
# MEDIA CONFIGURATION
# ==========================================
VITE_MEDIA_URL=https://yourdomain.com/media

# ==========================================
# FRONTEND CONFIGURATION
# ==========================================
VITE_FRONTEND_URL=https://your-app.vercel.app
VITE_APP_NAME=Parfumé

# ==========================================
# ENVIRONMENT
# ==========================================
VITE_ENVIRONMENT=production
VITE_DEBUG_MODE=false
```

---

## Local Development Environment Variables

Create `.env.local` in your project root:

```bash
# ==========================================
# DATABASE (H2 for local development)
# ==========================================
SPRING_PROFILES_ACTIVE=default

# ==========================================
# JWT
# ==========================================
JWT_SECRET=your-local-test-secret-key-change-in-production

# ==========================================
# CORS (Allow localhost ports)
# ==========================================
CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:8000,http://127.0.0.1:3000,http://127.0.0.1:5173

# ==========================================
# EMAIL (Gmail with App Password)
# ==========================================
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-16-char-app-password
MAIL_FROM=your-email@gmail.com

# ==========================================
# RAZORPAY (Test Mode)
# ==========================================
RAZORPAY_KEY_ID=rzp_test_your_test_key
RAZORPAY_KEY_SECRET=your_test_secret_key
RAZORPAY_WEBHOOK_SECRET=test_webhook_secret
RAZORPAY_CURRENCY=INR

# ==========================================
# FRONTEND
# ==========================================
FRONTEND_URL=http://localhost:3000

# ==========================================
# MEDIA
# ==========================================
MEDIA_URL=http://localhost:8080/media
MEDIA_UPLOAD_DIR=./media

# ==========================================
# LOGGING
# ==========================================
LOG_LEVEL=DEBUG
LOG_DIR=./logs
```

Create `frontend/.env.local` for local frontend development:

```bash
VITE_API_URL=http://localhost:8080/api
VITE_RAZORPAY_KEY=rzp_test_your_test_key
VITE_MEDIA_URL=http://localhost:8080/media
VITE_FRONTEND_URL=http://localhost:3000
VITE_ENVIRONMENT=development
VITE_DEBUG_MODE=true
```

---

## Step-by-Step Environment Setup Process

### 1. Generate JWT Secret

```bash
# Linux/Mac
openssl rand -base64 32

# Windows PowerShell
$bytes = [System.Security.Cryptography.RNGCryptoServiceProvider]::new()
$randomBytes = New-Object byte[] 32
$bytes.GetBytes($randomBytes)
[Convert]::ToBase64String($randomBytes)

# Or use Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# Or use Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

Example output: `AbCdEfGhIjKlMnOpQrStUvWxYzAbCdEfGhIjKlMnOpQr==`

### 2. Get Razorpay Live Keys

1. Go to https://dashboard.razorpay.com
2. Click Settings → API Keys
3. Toggle to "Live" mode (top right)
4. Copy:
   - Key ID: `rzp_live_xxxxxxxxxxxxx`
   - Key Secret: `keep this safe!`

### 3. Create SendGrid API Key

1. Go to https://sendgrid.com
2. Navigate to Settings → API Keys
3. Create new key with "Mail Send" permission
4. Copy the key (starts with `SG.`)

### 4. Setup Railway Database

1. Go to https://railway.app
2. Create new PostgreSQL service
3. Copy CONNECTION STRING (DATABASE_URL)
4. Extract credentials from CONNECTION STRING:
   - Username
   - Password
   - Hostname
   - Port
   - Database name

### 5. Deploy to Railway

1. Push code to GitHub
2. Connect GitHub repo to Railway
3. In Railway Dashboard:
   - Click "New" → Select GitHub repo
   - Click "Variables" tab
   - Paste all environment variables from "Railway Backend Environment Variables" section above
4. Railway auto-deploys
5. Copy the Railway API URL (e.g., `https://your-project.railway.app`)

### 6. Deploy to Vercel

1. Push frontend code to GitHub
2. Go to https://vercel.com
3. Click "New Project" → Select GitHub repo
4. Configure:
   - Framework: Vite
   - Root Directory: `./frontend` (if monorepo)
   - Build Command: `npm run build`
   - Output Directory: `dist`
5. Add environment variables from "Vercel Frontend Environment Variables" section
6. Deploy
7. Copy Vercel URL (e.g., `https://your-app.vercel.app`)

### 7. Configure Nginx Server

On your Nginx server (or use your domain's DNS):

1. Install Nginx (see main deployment guide)
2. Get SSL certificate with Let's Encrypt
3. Update `nginx-perfume-shop.conf` with:
   - Your domain name
   - Railway API URL
   - Vercel frontend URL
4. Copy config to: `/etc/nginx/sites-available/perfume-shop.conf`
5. Enable and reload:
   ```bash
   sudo ln -s /etc/nginx/sites-available/perfume-shop.conf \
               /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

---

## Verification Checklist

- [ ] Railway DATABASE_URL is set correctly
- [ ] JWT_SECRET is generated and set
- [ ] CORS_ORIGINS includes Vercel URL
- [ ] Razorpay live keys are configured (not test keys!)
- [ ] SendGrid API key is set
- [ ] Vercel frontend environment variables are set
- [ ] Nginx config has correct domain and URLs
- [ ] SSL certificate is installed
- [ ] Media directory is created with proper permissions

---

## Security Checklist

- [ ] Never commit `.env` files to Git
- [ ] Never commit JWT secret to Git
- [ ] Never commit Razorpay/SendGrid keys to Git
- [ ] Use Railway Secrets Manager for sensitive variables
- [ ] Verify HTTPS is enforced (HTTP redirects to HTTPS)
- [ ] Verify CORS is restricted to your domains
- [ ] Verify SSL certificate is valid (not expired)
- [ ] Verify media upload validates file types
- [ ] Verify API rate limiting is configured

---

## Troubleshooting Environment Variables

### Issue: "DATABASE_URL not set" error

**Solution:**
1. In Railway Dashboard, verify PostgreSQL service is created
2. Click on PostgreSQL service
3. Go to "Variables" tab
4. Copy DATABASE_URL value
5. Add to Railway app variables
6. Redeploy app

### Issue: "JWT_SECRET" not working

**Solution:**
1. Generate new secret: `openssl rand -base64 32`
2. Copy exact output (including special characters)
3. Update in Railway Variables
4. Click "Save" and "Redeploy"

### Issue: CORS errors when calling from Vercel

**Solution:**
1. Check Vercel URL (should be `https://xxx.vercel.app`)
2. Add to CORS_ORIGINS in Railway Variables:
   ```
   CORS_ORIGINS=https://xxx.vercel.app,https://www.yourdomain.com
   ```
3. Redeploy Railway app

### Issue: Media upload returns 404

**Solution:**
1. Check MEDIA_URL matches Nginx path
2. Verify Nginx `/media/` proxy is configured
3. Check directory exists: `ls -la /var/www/perfume-shop/media/`
4. Check permissions: `sudo chown -R www-data:www-data /var/www/perfume-shop/`

---

## Environment Variable Priority

1. **Railway Variables** (Production) - Highest priority
2. **.env.production** (Not used with Railway) - For local testing
3. **.env** (Local development) - For local development
4. **Default values in application.yml** - Lowest priority

---

## Key Environment Variables by Purpose

| Purpose | Variable | Priority | Where to Set |
|---------|----------|----------|--------------|
| Database connection | DATABASE_URL | Critical | Railway |
| JWT signing | JWT_SECRET | Critical | Railway |
| Frontend origin | CORS_ORIGINS | Critical | Railway |
| Razorpay payments | RAZORPAY_KEY_ID | High | Railway |
| Email sending | MAIL_USERNAME | High | Railway |
| Media serving | MEDIA_URL | Medium | Railway |
| Logging | LOG_LEVEL | Low | Railway |

