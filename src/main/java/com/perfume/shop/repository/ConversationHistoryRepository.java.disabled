package com.perfume.shop.repository;

import com.perfume.shop.entity.ConversationHistory;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Repository
public interface ConversationHistoryRepository extends JpaRepository<ConversationHistory, Long> {

    /**
     * Find all messages in a conversation
     */
    List<ConversationHistory> findByConversationIdOrderByMessageNumberAsc(String conversationId);

    /**
     * Find recent conversations for a user
     */
    List<ConversationHistory> findByUserIdOrderByCreatedAtDesc(String userId);

    /**
     * Find conversations in a date range
     */
    List<ConversationHistory> findByCreatedAtBetweenOrderByCreatedAtDesc(LocalDateTime startTime, LocalDateTime endTime);

    /**
     * Find unresolved conversations
     */
    List<ConversationHistory> findByIsResolvedFalseOrderByCreatedAtDesc();

    /**
     * Find conversations by session ID
     */
    List<ConversationHistory> findBySessionIdOrderByMessageNumberAsc(String sessionId);

    /**
     * Get the last message in a conversation
     */
    @Query("SELECT ch FROM ConversationHistory ch WHERE ch.conversationId = :conversationId ORDER BY ch.messageNumber DESC LIMIT 1")
    Optional<ConversationHistory> getLastMessageInConversation(@Param("conversationId") String conversationId);

    /**
     * Count messages in a conversation
     */
    int countByConversationId(String conversationId);

    /**
     * Find conversations by intent
     */
    List<ConversationHistory> findByUserIntentOrderByCreatedAtDesc(String userIntent);
}
